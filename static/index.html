<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>itch.io Scraper</title>
<style>
  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
    background: #1a1a2e;
    color: #e0e0e0;
    min-height: 100vh;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .container {
    width: 100%;
    max-width: 520px;
    padding: 2rem;
  }

  h1 {
    font-size: 1.6rem;
    font-weight: 700;
    margin-bottom: .25rem;
    color: #fa5c5c;
  }

  .subtitle {
    color: #888;
    font-size: .9rem;
    margin-bottom: 2rem;
  }

  .input-row {
    display: flex;
    gap: .5rem;
    margin-bottom: 1.5rem;
  }

  input[type="text"] {
    flex: 1;
    padding: .65rem .9rem;
    border: 2px solid #333;
    border-radius: 8px;
    background: #16213e;
    color: #e0e0e0;
    font-size: .95rem;
    outline: none;
    transition: border-color .2s;
  }

  input[type="text"]:focus { border-color: #fa5c5c; }

  input[type="text"]::placeholder { color: #555; }

  button {
    padding: .65rem 1.4rem;
    border: none;
    border-radius: 8px;
    background: #fa5c5c;
    color: #fff;
    font-size: .95rem;
    font-weight: 600;
    cursor: pointer;
    transition: background .2s, transform .1s;
    white-space: nowrap;
  }

  button:hover:not(:disabled) { background: #e04848; }
  button:active:not(:disabled) { transform: scale(.97); }
  button:disabled { opacity: .5; cursor: not-allowed; }

  .status {
    min-height: 120px;
    background: #16213e;
    border-radius: 10px;
    padding: 1.2rem;
    font-size: .85rem;
    line-height: 1.6;
    display: none;
  }

  .status.visible { display: block; }

  .progress-bar-track {
    height: 6px;
    background: #222;
    border-radius: 3px;
    margin-bottom: .8rem;
    overflow: hidden;
  }

  .progress-bar-fill {
    height: 100%;
    width: 0%;
    background: linear-gradient(90deg, #fa5c5c, #ff8a5c);
    border-radius: 3px;
    transition: width .3s ease;
  }

  .log { max-height: 180px; overflow-y: auto; }
  .log p { margin-bottom: .15rem; color: #aaa; }
  .log p::before { content: "✓ "; color: #4caf50; }

  .error { color: #fa5c5c; font-weight: 600; }

  .download-link {
    display: inline-block;
    margin-top: 1rem;
    padding: .6rem 1.2rem;
    background: #0f3460;
    color: #5ce1fa;
    border-radius: 8px;
    text-decoration: none;
    font-weight: 600;
    transition: background .2s;
  }

  .download-link:hover { background: #1a4a7a; }
</style>
</head>
<body>
<div class="container">
  <h1>itch.io Scraper</h1>
  <p class="subtitle">Enter a creator's username to archive their public projects.</p>

  <div class="input-row">
    <input type="text" id="creator" placeholder="e.g. mossfield" autofocus>
    <button id="go" type="button">Scrape</button>
  </div>

  <div class="status" id="status">
    <div class="progress-bar-track"><div class="progress-bar-fill" id="bar"></div></div>
    <div class="log" id="log"></div>
  </div>
</div>

<script>
const input  = document.getElementById("creator");
const goBtn  = document.getElementById("go");
const status = document.getElementById("status");
const bar    = document.getElementById("bar");
const log    = document.getElementById("log");

input.addEventListener("keydown", e => { if (e.key === "Enter") goBtn.click(); });

goBtn.addEventListener("click", async () => {
  const creator = input.value.trim().toLowerCase();
  if (!creator) return;

  goBtn.disabled = true;
  status.classList.add("visible");
  bar.style.width = "0%";
  log.innerHTML = "<p style='color:#888'>Starting…</p>";

  let jobId;
  try {
    const res = await fetch("/api/scrape", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ creator }),
    });
    if (!res.ok) {
      const err = await res.json();
      throw new Error(err.detail || "Request failed");
    }
    const data = await res.json();
    jobId = data.job_id;
  } catch (e) {
    log.innerHTML = `<p class="error">${e.message}</p>`;
    goBtn.disabled = false;
    return;
  }

  const poll = setInterval(async () => {
    try {
      const res = await fetch(`/api/status/${jobId}`);
      const job = await res.json();

      if (job.total > 0) {
        const pct = Math.round((job.progress.length / job.total) * 100);
        bar.style.width = pct + "%";
      }

      log.innerHTML = job.progress
        .map(p => `<p>${esc(p)}</p>`)
        .join("");
      log.scrollTop = log.scrollHeight;

      if (job.status === "done") {
        clearInterval(poll);
        bar.style.width = "100%";
        log.innerHTML += `<a class="download-link" href="/api/download/${jobId}">Download ZIP</a>`;
        goBtn.disabled = false;
      } else if (job.status === "error") {
        clearInterval(poll);
        log.innerHTML += `<p class="error">${esc(job.error)}</p>`;
        goBtn.disabled = false;
      }
    } catch { /* retry next tick */ }
  }, 800);
});

function esc(s) {
  const d = document.createElement("div");
  d.textContent = s;
  return d.innerHTML;
}
</script>
</body>
</html>
